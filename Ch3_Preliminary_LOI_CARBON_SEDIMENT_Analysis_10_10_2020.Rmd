---
title: "Updated Analysis of Carbon DATA"
author: "Jenn_McHenry"
date: "3/02/2021"
output: html_document
---

## R Markdown

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(lubridate)
library(plyr)
library(raster)
library(sp)
library(ggplot2)
```

#Loading in the seagrass survey data 
```{r}

#Seagrass Data
seagrass_surveys=read.csv("data_output/Seagrass_Species_Cover_QAQC_with_Environmental_Factors.csv")
head(seagrass_surveys)
summary(seagrass_surveys)
names(seagrass_surveys)

seagrass_surveys=seagrass_surveys%>%
  mutate(Seagrass_Spp=(Thalassia.testudinum+Syringodium.filiforme+Halodule.wrightii+Halophila.decipens+Halophila.engelmanni+Ruppia.maritima),Algal_Spp=(Acanthophora.spicifera+Caulerpa.verticillata+Halimeda.incrassata+Penicillus.capitatus+Sargassum+Udotea.flabellum))


#Seagrass Clippings
seagrass_clippings=read.csv("data/Carbon/Seagrass_Clippings_Data_version_11_23_2020.csv")

seagrass_clippings=seagrass_clippings%>%
  mutate(Dry_Weight_Corrected=Dry.Weight..g.- Boat.Weight..g.)

names(seagrass_clippings)

seagrass_clippings=seagrass_clippings[c(2:7,17,16)]

colnames(seagrass_clippings)<-c("Site","Quadrat","Species","Common.Name","Species_Type","Biomass_Type","Sample_gDW","Notes")

seagrass_clippings=seagrass_clippings%>%
  dplyr::filter(Species_Type=="SAV" | Species_Type=="Algae")%>%
  filter(Biomass_Type=="AGB" | Biomass_Type=="ABG")%>%
  filter(Sample_gDW>0)
summary(seagrass_clippings)
names(seagrass_clippings)

seagrass_clippings_Quadrat=seagrass_clippings%>%
  dplyr::group_by(Site,Quadrat,Species)%>%
  dplyr::summarize(Biomass_gDW=mean(Sample_gDW))%>%
  dplyr::filter(Species!="epiphytic_algae")%>%
  tidyr::spread(key = Species,value = Biomass_gDW,fill = 0)%>%
  mutate(Macro_Algae_Biomass_gDW=Acanthophora_spicifera+filamentous_red_algae+Halimeda_incrassata+Penicillus_sp +  branched_red_algae + Udotea_flabellum_)%>%
  mutate(Seagrass_Biomass_gDW= Halodule_wrightii + Halophila_decipiens + Halophila_engelmanni + Ruppia_maritima + Syringodium_filiforme + Thalassia_testudinum) 


colnames(seagrass_clippings_Quadrat)<-c("Site","Quadrat","Acanthophora_spicifera_gDW", "Branched_red_algae","Filamentous_algae_gDW", "Halimeda_incrassata_gDW","Halodule_wrightii_gDW",
                                     "Halophila_decipiens_gDW", 
                                     "Halophila_engelmanni_gDW",
                                     "Penicillus_sp_gDW",
                                     "Ruppia_maritima_gDW",
                                     "Syringodium_filiforme_gDW",
                                     "Thalassia_testudinum_gDW",  
                                     "Udotea_flabellum_gDW","Unidentified_Alga_gDW", "Macro_Algae_Biomass_gDW","Seagrass_Biomass_gDW" )

levels(as.factor(seagrass_clippings$Quadrat))


Compation_Ratio=read.csv("data/Carbon/Core_Length_Data_version_10_07_2020.csv")
names(Compation_Ratio)
colnames(Compation_Ratio)<-c("Date","Region","Site","Dive.Name","Original_Quadrat","Insertion_Depth_cm","Core_Length_cm","Compaction_Ratio","Alt_Number","Quadrat","Notes")
dim(Compation_Ratio)
Compation_Ratio=unique(Compation_Ratio)
dim(Compation_Ratio)

Compation_Ratio=Compation_Ratio[c(3,10,6:9)]

Compation_Ratio=Compation_Ratio%>%
  mutate(Compaction_Ratio=round(Compaction_Ratio,2),Core_Length_Corrected_cm=Core_Length_cm*(1/Compaction_Ratio))

levels(Compation_Ratio$Site)

#Sediment Data
Sediment=read.csv("data/Carbon/Sediment_Data_version_03_31_2020.csv")
Sediment=Sediment[c(2:8)]

names(Sediment)<-c("Site","Quadrat","Bagged_Slice_Number","Slice_Number","Analysis","Rhizome_Removed","Slice_Height_cm")

Sediment_QAQC=join(Sediment,Compation_Ratio,by=c("Site","Quadrat"))
Sediment_QAQC=Sediment_QAQC%>%
  dplyr::mutate(Slice_Height_cm=as.numeric(Slice_Height_cm),
                Slice_Height_Corrected_cm=Slice_Height_cm*(1/Compaction_Ratio)) 

Slice_Height_Corrected_cm_Mean=Sediment_QAQC%>%
  dplyr::select(Site,Quadrat,Slice_Height_Corrected_cm)%>%
  dplyr::group_by(Site,Quadrat)%>%
  dplyr::summarize(Mean_Slice_Height_Corrected_cm=mean(Slice_Height_Corrected_cm,na.rm=TRUE))
  # dplyr::mutate(Mean_Slice_Height_Corrected_cm=round(Mean_Slice_Height_Corrected_cm,2))
                
Sediment_QAQC=join(Sediment_QAQC,Slice_Height_Corrected_cm_Mean,by=c("Site","Quadrat"))            

#Code graveyard for calculating the sediment depth
  # dplyr::arrange(desc(Site,Quadrat,Slice_Number))%>%
  # dplyr::group_by(Site,Quadrat)%>%
  # dplyr::mutate(Sediment_Depth_cm=ave(Slice_Height_Corrected_cm, Site,Quadrat, FUN=cumsum)) # a cumulative sum doesn't work because we haven't processed all of the core slices.......Have to do slice number * 2 and then correct for the overall compaction of the core.... It won't be precise. But its best way I can think of right now without haveing someong go back through the bags to check that some slices are larger....
  


#LOI Data
LOI=read.csv("data/Carbon/LOI_Data_version_03_18_2021.csv")
# head(LOI)
names(LOI)

LOI=LOI[c(2:8,11:12,23:35)]
names(LOI)
# head(LOI)

colnames(LOI)=c("Site","Quadrat","Bagged_Slice_Number","Slice_Number","Analysis","Rhizome_Removed","Slice_Height_cm","Shell_gDW","Rhizome_gDW","Frac_OLOI","Frac_ILOI","OLOI","ILOI","Sample_Weight_gDW","Sediment_Weight_gDW","Sample_Density_g_per_ml","Sediment_Density_g_per_ml","Organic_Content_gDW","Inorganic_Content_gDW","Organic_Content_Density_g_per_ml","Inorganic_Content_Density_g_per_ml","Percent_Carbon")
levels(LOI$Site)
levels(as.factor(LOI$Quadrat))


LOI=join(Compation_Ratio[c(1:2,4,5,7)],LOI,by=c("Site","Quadrat"))

LOI=join(LOI,Sediment_QAQC[c(1:2,4,13:14)],by=c("Site","Quadrat","Slice_Number"),type="left")
levels(Compation_Ratio$Site)
levels(as.factor(Compation_Ratio$Quadrat))

levels(LOI$Site)
levels(as.factor(LOI$Quadrat))


## GOTTA CHECK THE CALCULATIONS REALLY CLOSELY. I THINK WE NEED TO MULTIPLY PERCENTAGES BY GRAMS BEFORE DIVDING BY THE CORRECTED VOLUME.
# RIGHT NOW I'M CALCULATING DENSITIES AND THEN MULTIPLYING THE PERCENTAGES

LOI_QAQC=LOI%>%
  dplyr::mutate(Slice_Area_cm2=pi*(2.54^2),Slice_Volume_cm3=Slice_Area_cm2*Slice_Height_Corrected_cm)%>%
 dplyr::mutate(Sample_Density_g_per_ml=Sample_Weight_gDW/Slice_Volume_cm3,
         Sediment_Density_g_per_ml=Sediment_Weight_gDW/Slice_Volume_cm3,
         Organic_Content_Density_g_per_ml=Frac_OLOI * Sediment_Density_g_per_ml,
         Inorganic_Content_Density_g_per_ml=Frac_ILOI * Sediment_Density_g_per_ml)%>%
 dplyr::mutate(Frac_Shell=(Shell_gDW)/Sample_Weight_gDW,
         Shell_Density_g_per_ml=Frac_Shell*Sample_Density_g_per_ml, 
         Frac_Rhizome=Rhizome_gDW/Sample_Weight_gDW,
         Rhizome_Density_g_per_ml=Frac_Rhizome*Sample_Density_g_per_ml,
         Rhizome_Density_g_per_ml=ifelse(Rhizome_Removed=="Y",Rhizome_Density_g_per_ml,NA))%>%
  dplyr::select(1:10,26:29,15:16,25,19:20,23:24,31,33)%>%
    dplyr::mutate(Factor=ifelse(Site=="SJBA" | Site=="SJBB" | Site=="SJBC" | Site=="SMARA" | Site=="SMARB" | Site=="SMARC" | Site=="STCHA" |Site=="STCHB" |Site=="STCHC"  ,"Control","Seagrass"),
         Percent_Carbon=(0.4839*OLOI)-0.3648,
         Percent_Carbon=ifelse(Percent_Carbon<0,0.001,Percent_Carbon))



# test<-LOI_QAQC%>%
#     dplyr::select(Factor,Site,Quadrat,Core_Length_cm,Core_Length_Corrected_cm,Slice_Number,Slice_Height_cm,Mean_Slice_Height_Corrected_cm,Compaction_Ratio)%>%
#    dplyr::mutate(diff_slice_height=Slice_Height_cm-2)%>%
#   dplyr::group_by(Factor,Site,Quadrat)%>%
#   dplyr::summarize(original_length=unique(Core_Length_cm),max_slice=max(Slice_Number),added_height=sum(diff_slice_height))%>%
#   mutate(length_calculated=(max_slice*2)+added_height,diff=original_length-length_calculated)
#   
#figurig out the proper slice depth 
Core_Length_QAQC<-LOI_QAQC%>%
  dplyr::select(Factor,Site,Quadrat,Core_Length_cm,Core_Length_Corrected_cm,Slice_Number,Slice_Height_cm,Mean_Slice_Height_Corrected_cm,Compaction_Ratio)%>%
  dplyr::mutate(Sediment_Depth_cm=round(Slice_Height_cm*Slice_Number,2),
         Sediment_Depth_cm_uncompressed=round(Sediment_Depth_cm*(1/Compaction_Ratio)),
         Sediment_Depth_cm_mean_uncompressed=round(Mean_Slice_Height_Corrected_cm,2)*Slice_Number)%>%
  dplyr::group_by(Factor,Site,Quadrat)%>%
  dplyr::summarize(Compaction_Ratio=unique(Compaction_Ratio),
                   original_length=unique(Core_Length_cm),
                   length=unique(round(Core_Length_Corrected_cm,2)),
                   length_calculated_from_slice=max(Sediment_Depth_cm),
                   length_calculated_from_uncompressed_slice=max(Sediment_Depth_cm_uncompressed),
                   length_calculated_from_uncompressed_slice_mean=max(Sediment_Depth_cm_mean_uncompressed))%>%
  dplyr::mutate(diff=length-length_calculated_from_slice,
                   diff_uncompressed=length-length_calculated_from_uncompressed_slice,
                   diff_uncompressed_mean=length-length_calculated_from_uncompressed_slice_mean)

write.csv(Core_Length_QAQC,file="data_output/Core_Lengths_Information_QAQC_03_31_2021.csv")

ggplot(Core_Length_QAQC,aes(length))+geom_histogram()+facet_wrap(~Factor)

LOI_QAQC=LOI_QAQC%>%
   mutate(Sediment_Depth_cm_uncompressed=Slice_Height_cm*(1/Compaction_Ratio)*Slice_Number)%>%
   group_by(Site,Quadrat)%>%
   dplyr::mutate(Sediment_Depth_Group=ifelse(Sediment_Depth_cm_uncompressed<=10, "0-10cm", ifelse(Sediment_Depth_cm_uncompressed>10 & Sediment_Depth_cm_uncompressed<=20,"10-20cm",ifelse(Sediment_Depth_cm_uncompressed>20 & Sediment_Depth_cm_uncompressed<=30,"20-30cm",ifelse(Sediment_Depth_cm_uncompressed>30& Sediment_Depth_cm_uncompressed<=40,"30-40cm","40-50cm")))))
         

write.csv(LOI_QAQC,file="data_output/LOI_Data_version_QAQC_03_31_2020.csv")

#Grain size analysis 
Grainsize=read.csv("data/Carbon/Grainsize_Data_version_03_18_2021.csv")
Grainsize=as.data.frame(Grainsize)
# head(Grainsize)
summary(Grainsize)
names(Grainsize)

Grainsize=Grainsize%>%
  mutate(Qualtiy.Control.Chedck=round(Qualtiy.Control.Chedck,2))%>%
  mutate(Fraction.of.Pebbles=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Pebbles),
         Fraction.of.Gravel=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Gravel),
         Fraction.of.Coarse.Sand=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Coarse.Sand),
         Fraction.of.Medium.Sand=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Medium.Sand),
         Fraction.of.Fine.Sand=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Fine.Sand),
         Fraction.of.Silt.Mud=ifelse(Qualtiy.Control.Chedck>1.01,NA,Fraction.of.Silt.Mud))

Grainsize_QAQC=Grainsize[c(2:11,18:23)]
names(Grainsize_QAQC)
levels(Grainsize_QAQC$Site)
levels(LOI_QAQC$Site)


colnames(Grainsize_QAQC)=c("Site","Quadrat","Bagged_Slice_Number","Slice_Number","Analysis","Rhyzome_Removed","Slice_Height_cm","Sample_Weight_gDW","Rhizome_gDW","Sediment_Weight_gDW","Frac_Pebbles","Frac_Gravel","Frac_Coarse_Sand","Frac_Medium_Sand","Frac_Fine_Sand","Frac_Silt")


Grainsize_QAQC=join(Compation_Ratio[c(1:2,5,7)],Grainsize_QAQC,by=c("Site","Quadrat"))
levels(Grainsize_QAQC$Site)


Grainsize_QAQC=Grainsize_QAQC%>%
  # mutate(Rhizome_Removed=ifelse(Slice_Number==4,"Y","N"))%>%
  dplyr::mutate(Slice_Height_Corrected_cm=Slice_Height_cm*(1/Compaction_Ratio),Slice_Area_cm2=pi*(2.54^2),Slice_Volume_cm3=Slice_Area_cm2*Slice_Height_Corrected_cm, Sediment_Depth_cm_uncompressed=Slice_Height_Corrected_cm*Slice_Number)%>%
  mutate(Sample_Density_g_per_ml=Sample_Weight_gDW/Slice_Volume_cm3,
         Sediment_Density_g_per_ml=Sediment_Weight_gDW/Slice_Volume_cm3,
         Frac_Rhizome=Rhizome_gDW/Sample_Weight_gDW,
         Rhizome_Density_g_per_ml=Frac_Rhizome*Sample_Density_g_per_ml)%>%
    dplyr::mutate(Factor=ifelse(Site=="SJBA" | Site=="SJBB" | Site=="SJBC" | Site=="SMARA" | Site=="SMARB" | Site=="SMARC" | Site=="STCHA" |Site=="STCHB" |Site=="STCHC" ,"Control","Seagrass"))%>%
  mutate(Percent_Shell=Frac_Pebbles*100,Percent_Gravel=Frac_Gravel*100,Percent_Coarse=Frac_Coarse_Sand*100,Percent_Medium=Frac_Medium_Sand*100,Percent_Fine=Frac_Fine_Sand*100,Percent_Silt=Frac_Silt*100)%>%
  dplyr::select(1:8,19:33)

names(Grainsize_QAQC)

# Grainsize_QAQC=Grainsize_QAQC%>%
#   mutate(Percent_Sands=Percent_Coarse+Percent_Medium+Percent_Fine)

write.csv(Grainsize_QAQC,file="data_output/Grainsize_Data_version_QAQC_03_30_2021.csv")


```


#Basic Plots
```{r}
names(LOI_QAQC)

ggplot(Compation_Ratio,aes(x=Compaction_Ratio))+geom_histogram()+xlab("Compaction Ratio") +ylab("Number of Cores")

Compation_Ratio%>%
  ggplot(aes(x=round(Core_Length_Corrected_cm,0)))+geom_histogram()+xlab("Uncompressed Core Length (cm)") +ylab("Number of Cores") 

ggplot(LOI_QAQC,aes(x=round(Sediment_Depth_cm_uncompressed,0)))+geom_histogram(binwidth = 1)+xlab("Sediment Depth (cm)") +ylab("Number of Core Slices")

#Sediments
Grainsize_QAQC_long=Grainsize_QAQC%>%
  dplyr::select(1:2,13:14,16:23)%>%
  gather(key="Grainsize","Percent",7:12)


#grainsizes
ggplot(Grainsize_QAQC_long,aes(x=as.integer(Percent),fill=Factor))+geom_density(position = "dodge",alpha=0.5) + xlab("Percent Grainsize per Slice") + ylab("Frequency") + facet_wrap(~Grainsize,scale="free_y")

```



#Looking at slice level data
```{r}
names(LOI_QAQC)

LOI_QAQC_By_Site_Slice=LOI_QAQC%>%
  # dplyr::filter(Sediment_Depth_cm_uncompressed<=40)%>%
  dplyr::group_by(Site,Factor,Quadrat,Bagged_Slice_Number,Slice_Number,Slice_Height_Corrected_cm,Sediment_Depth_Group)%>%
  dplyr::summarize(Sediment_Depth_cm=unique(round(Sediment_Depth_cm_uncompressed,0)),OLOI=mean(OLOI,na.rm=TRUE),ILOI=mean(ILOI,na.rm=TRUE),Organic_Content_Density_g_per_ml=mean(Organic_Content_Density_g_per_ml,na.rm=TRUE),Inorganic_Content_Density_g_per_ml=mean(Inorganic_Content_Density_g_per_ml,na.rm=TRUE),Percent_Carbon=mean(Percent_Carbon,na.rm=TRUE),Rhizome_Density_g_per_ml=mean(Rhizome_Density_g_per_ml,na.rm=TRUE),Shell_Density_g_per_ml=mean(Shell_Density_g_per_ml,na.rm=TRUE),Sediment_Density_g_per_ml=mean(Sediment_Density_g_per_ml,na.rm=TRUE),Sample_Density_g_per_ml=mean(Sample_Density_g_per_ml,na.rm=TRUE))%>% #calling sediment depth as is to avoid renaming below. But not its the uncompressed versions
  ungroup()%>%
  filter(is.na(OLOI)==FALSE)%>%
  dplyr::mutate(Organic_Carbon_Density_g_per_ml=(Percent_Carbon/100) * Sediment_Density_g_per_ml,
         Inorganic_Carbon_Density_g_per_ml=(Inorganic_Content_Density_g_per_ml* 0.12),
         Total_Carbon_Density_g_per_ml=Organic_Carbon_Density_g_per_ml+Inorganic_Carbon_Density_g_per_ml)%>%
    mutate(Sediment_Depth_Factor=ifelse(Sediment_Depth_cm<15,"shallow","deep"))%>%
  mutate(Sediment_Depth_Factor=factor(Sediment_Depth_Factor,levels=c("shallow","deep")))


LOI_QAQC_By_Site_Slice%>%
  dplyr::group_by(Sediment_Depth_Group,Factor)%>%
  dplyr::summarise(mean=mean(OLOI),n=n())

ggplot(LOI_QAQC_By_Site_Slice,aes(x=(Sediment_Depth_cm)))+geom_histogram(binwidth = 1)+xlab("Sediment Depth (cm)") +ylab("Frequency")

#Rhizome 
ggplot(LOI_QAQC_By_Site_Slice,aes(y=Rhizome_Density_g_per_ml,fill=Factor),na.rm=TRUE)+geom_boxplot() +ylab("Rhizome g/ml") + xlab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Rhizome Content (g/ml) by Sediment Depth Bin (%)")


#OM %
ggplot(LOI_QAQC_By_Site_Slice,aes(y=as.integer(OLOI),fill=Factor),na.rm=TRUE)+geom_boxplot() +ylab("Sedimentary Organics Per Slice") + xlab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Organic Matter by Sediment Depth Bin (%)")


#OM Density
ggplot(LOI_QAQC_By_Site_Slice,aes(y=(Organic_Content_Density_g_per_ml),fill=Factor),na.rm=TRUE)+geom_boxplot() + ylab("Organic Density of Slice") + ylab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Organic Density by Sediment Depth Bin (g/ ml)")

#IOM %
ggplot(LOI_QAQC_By_Site_Slice,aes(y=as.integer(ILOI),fill=Factor),na.rm=TRUE)+geom_boxplot() + ylab("Sedimentary Carbonates Per Slice") + ylab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ggtitle("Carbonates by Sediment Depth Bin (%)")

#Inorganic Density
ggplot(LOI_QAQC_By_Site_Slice,aes(y=(Inorganic_Content_Density_g_per_ml),fill=Factor),na.rm=TRUE)+geom_boxplot() + ylab("Carbonate Density of Slice") + xlab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Carbonate Density by Sediment Depth Bin (g/ ml)")

#% Organic C
ggplot(LOI_QAQC_By_Site_Slice,aes(y=(Percent_Carbon),fill=Factor),na.rm=TRUE)+geom_boxplot() + ylab("Organic Carbon Per Slice") + ylab("") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ggtitle("Organic Carbon by Sediment Depth Bin (%)")

#Organic Carbon Density
ggplot(LOI_QAQC_By_Site_Slice,aes(y=(Organic_Carbon_Density_g_per_ml),fill=Factor),na.rm=TRUE)+geom_boxplot() + xlab("Organic Carbon Density of Slice") + ylab("Number of Core Slices") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Organic Carbon Density by Sediment Depth Bin (g/ml)")

#Total Carbon Density
ggplot(LOI_QAQC_By_Site_Slice,aes(y=(Total_Carbon_Density_g_per_ml),fill=Factor),na.rm=TRUE)+geom_boxplot() + xlab("Total Caron Density of Slice") + ylab("Number of Core Slices") +facet_wrap(~Sediment_Depth_Group,nrow=1)+ ggtitle("Total Carbon Density by Sediment Depth Bin (g/ ml)")


## BY DEPTH
# Rhizome (g/ml) 
LOI_QAQC_By_Site_Slice%>%
  dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
  dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm)%>%
  dplyr::summarize(mean=mean(Rhizome_Density_g_per_ml,na.rm=TRUE))%>%
  mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%
    ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm",) + ylab("Rhizome Density (g/cm3) of Slice") + xlab("Sediment Depth (cm)") + ggtitle("Rhizome Content by Sediment Depth ")+coord_flip()#+xlim(-13,0)

#testing for relationship with slice depth 
rhiz_depth_lm=lm(Rhizome_Density_g_per_ml ~ Sediment_Depth_cm *Factor, data=LOI_QAQC_By_Site_Slice)
summary(rhiz_depth_lm)


# Shell  (g/ml) 
LOI_QAQC_By_Site_Slice%>%
  dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
  dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm,Sediment_Depth_Factor)%>%
  dplyr::summarize(mean=mean(Shell_Density_g_per_ml,na.rm=TRUE))%>%
  mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%              ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm") + ylab("Shell Density (g/cm3) of Slice") + xlab("Sediment Depth (cm)") + ggtitle("Shell Content by Sediment Depth ")+coord_flip()#+facet_wrap(~Sediment_Depth_Factor,scales = "free_y")

#testing for relationship with slice depth 
shell_depth_lm=lm(Shell_Density_g_per_ml ~  Factor *Sediment_Depth_cm, data=LOI_QAQC_By_Site_Slice)
summary(shell_depth_lm)

# # Percent OLOI
# LOI_QAQC_By_Site_Slice%>%
#   dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
#   dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm,Sediment_Depth_Factor)%>%
#   dplyr::summarize(mean=mean(OLOI,na.rm=TRUE))%>%
#   dplyr::mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%              ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm",) + ylab("OM % of Slice") + xlab("Sediment Depth (cm)") + ggtitle("Organic Content by Sediment Depth ")+coord_flip()+facet_wrap(~Sediment_Depth_Factor,scale="free_y")
# 
# OLOI_shallow_lm=lm(OLOI ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="shallow",])
# summary(OLOI_shallow_lm)
# 
# OLOI_deep_lm=lm(OLOI ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="deep",])
# summary(OLOI_deep_lm)

# # Percent Inorganic Content
# LOI_QAQC_By_Site_Slice%>%
#   dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
#   # filter(Site!="STCHC")%>%
#   dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm,Sediment_Depth_Factor)%>%
#   dplyr::summarize(mean=mean(ILOI,na.rm=TRUE))%>%
#   mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%
#               ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm",) + ylab("% Carbonte of Slice") + xlab("Sediment Depth (cm)") + ggtitle("Carbonate Content by Sediment Depth ")+coord_flip() +facet_wrap(~Sediment_Depth_Factor, scale="free_y")
# 
# ILOI_shallow_lm=lm(ILOI ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="shallow",])
# summary(ILOI_shallow_lm)
# 
# ILOI_deep_lm=lm(ILOI ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="deep",])
# summary(ILOI_deep_lm)
                  # data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Site!="STCHC",])
summary(ILOI_depth_lm)

# Organic Carbon Density
LOI_QAQC_By_Site_Slice%>%
  dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
  dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm,Sediment_Depth_Factor)%>%
  dplyr::summarize(mean=mean(Organic_Carbon_Density_g_per_ml,na.rm=TRUE))%>%
  mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%
              ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm",) + ylab("OC Density (g/cm3)") + xlab("Sediment Depth (cm)") + ggtitle("OC Density by Sediment Depth ")+coord_flip()+facet_wrap(~Sediment_Depth_Factor, scale="free_y")


OCD_all_lm=lm(Organic_Carbon_Density_g_per_ml ~ Factor * Sediment_Depth_cm, data=LOI_QAQC_By_Site_Slice)
summary(OCD_all_lm)

OCD_shallow_lm=lm(Organic_Carbon_Density_g_per_ml ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="shallow",])
summary(OCD_shallow_lm)

OCD_deep_lm=lm(Organic_Carbon_Density_g_per_ml ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="deep",])
summary(OCD_deep_lm)


# Inorganic Carbon Density
LOI_QAQC_By_Site_Slice%>%
  dplyr::mutate(Sediment_Depth_cm=as.factor(as.integer(Sediment_Depth_cm)))%>%
  dplyr::group_by(Factor,Site,Quadrat,Sediment_Depth_cm,Sediment_Depth_Factor)%>%
  dplyr::summarize(mean=mean(Inorganic_Carbon_Density_g_per_ml,na.rm=TRUE))%>%
  mutate(Sediment_Depth_cm=as.integer(Sediment_Depth_cm))%>%
              ggplot(aes(y=(mean),x=-Sediment_Depth_cm,color=Factor,fill=Factor))+geom_point() + geom_smooth(method="lm",) + ylab("IOC Density (g/cm3)") + xlab("Sediment Depth (cm)") + ggtitle("IOC Density by Sediment Depth ")+coord_flip()+facet_wrap(~Sediment_Depth_Factor, scale="free_y")



ICD_all_lm=lm(Inorganic_Carbon_Density_g_per_ml ~ Factor +Sediment_Depth_cm, data=LOI_QAQC_By_Site_Slice)
summary(ICD_all_lm)

ICD_shallow_lm=lm(Inorganic_Carbon_Density_g_per_ml ~ Sediment_Depth_cm + Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="shallow",])
summary(ICD_shallow_lm)

ICD_deep_lm=lm(Inorganic_Carbon_Density_g_per_ml ~ Sediment_Depth_cm * Factor, data=LOI_QAQC_By_Site_Slice[LOI_QAQC_By_Site_Slice$Sediment_Depth_Factor=="deep",])
summary(ICD_deep_lm)

```

#Combinging analytical datasets to Quadrat level 
```{r}
LOI_QAQC_Quadrat_Level_By_DepthBin=LOI_QAQC_By_Site_Slice%>%
  mutate(Organic_accum_per_cm=Organic_Content_Density_g_per_ml*Slice_Height_Corrected_cm,
  Inorganic_accum_per_cm=Inorganic_Content_Density_g_per_ml*Slice_Height_Corrected_cm,
  Shell_accum_per_cm=Shell_Density_g_per_ml*Slice_Height_Corrected_cm,
  Rhizome_accum_per_cm=Rhizome_Density_g_per_ml*Slice_Height_Corrected_cm,
  Organic_Carbon_accum_per_cm=Organic_Carbon_Density_g_per_ml*Slice_Height_Corrected_cm,
  Inorganic_Carbon_accum_per_cm=Inorganic_Carbon_Density_g_per_ml*Slice_Height_Corrected_cm)%>%
  dplyr::group_by(Site,Factor,Sediment_Depth_Factor,Quadrat)%>% #AVERAGING WITHIN A QUADRAT
  dplyr::summarize(OLOI=mean(OLOI,na.rm=TRUE),
                   ILOI=mean(ILOI,na.rm=TRUE),
                   Carbon=mean(Percent_Carbon,na.rm=TRUE),
                   Organic_accum_per_cm=mean(Organic_accum_per_cm,na.rm=TRUE),
                   Inorganic_accum_per_cm=mean(Inorganic_accum_per_cm,na.rm=TRUE),
                   Shell_accum_per_cm=mean(Shell_accum_per_cm,na.rm=TRUE),
                   Rhizome_accum_per_cm=mean(Rhizome_accum_per_cm,na.rm=TRUE),
                   Organic_Carbon_accum_per_cm=mean(Organic_Carbon_accum_per_cm,na.rm=TRUE),
                   Inorganic_Carbon_accum_per_cm=mean(Inorganic_Carbon_accum_per_cm,na.rm=TRUE))%>% # Converting the estiamtes to Value within a squre meter area up to 50cm sediment depth. (and 10 cm depth for rhizomes)
  dplyr::mutate(Stock_Scaling_Factor=ifelse(Sediment_Depth_Factor=="shallow",15,35),
                OM_g_per_sqm=Organic_accum_per_cm*(1/0.0001)*Stock_Scaling_Factor,
         IOM_g_per_sqm=Inorganic_accum_per_cm*(1/0.0001)*Stock_Scaling_Factor,
         Shell_g_per_sqm=Shell_accum_per_cm*(1/0.0001)*Stock_Scaling_Factor,
         Rhizome_g_per_sqm=Rhizome_accum_per_cm*(1/0.0001)*15,
         OC_Stock_g_per_sqm=Organic_Carbon_accum_per_cm*(1/0.0001)*Stock_Scaling_Factor,
         IOC_Stock_g_per_sqm=Inorganic_Carbon_accum_per_cm*(1/0.0001)*Stock_Scaling_Factor,
         Total_C_Stock_g_per_sqm=IOC_Stock_g_per_sqm+OC_Stock_g_per_sqm)%>%
  dplyr::ungroup()

Reference_Combo=LOI_QAQC_Quadrat_Level_By_DepthBin[c(1:2,4)]
Reference_Combo=unique(Reference_Combo)


seagrass_surveys_By_Quadrat=join(Reference_Combo,seagrass_surveys[c(1:8,15:22,32:36,76:77)],by=c("Site","Quadrat"),type="left",match="first")
  
  
  
seagrass_surveys_By_Quadrat=seagrass_surveys_By_Quadrat%>%
  mutate(Total_Seagrass_Cover=(Seagrass_Spp/100)*(SAV_Cover/100)*100,
         Total_Algae_Cover=(Algal_Spp/100)*(SAV_Cover/100)*100)


ggplot(seagrass_surveys_By_Quadrat,aes(x=Epiphite_Blade_Load,fill=Region))+geom_boxplot()+xlab("Epiphtye Blade Load (% of Blades)") +ylab("Regions")+coord_flip()+ggtitle("A")

ggplot(seagrass_surveys_By_Quadrat,aes(x=Epiphite_Shoot_Load,fill=Region))+geom_boxplot()+xlab("Epiphtye Shoot Load (% of Shoots)") +ylab("Regions")+coord_flip()+ggtitle("B")


seagrass_survey_AND_Clippings_By_Quadrat=join(seagrass_surveys_By_Quadrat,seagrass_clippings_Quadrat[c(1:2,17,16,13,12,7)],by=c("Site","Quadrat"))

Environmental_Factors_Sites=seagrass_surveys%>%
  dplyr::select(Site,Latitude,Longitude,Temperature.Mean,Current.Velocity.Mean,Salinity.Min,Chlorophyll.Mean,Nitrate.Mean,Phosphate.Mean,Light.bottom.Min,Par.Mean,Dist_To_River,Dist_To_Shore)%>%
  group_by(Site)%>%
  dplyr::summarize(Latitude=mean(Latitude,na.rm=TRUE),Longitude=mean(Longitude,na.rm=TRUE),Temperature.Mean=mean(Temperature.Mean,na.rm=TRUE),Current.Velocity.Mean=mean(Current.Velocity.Mean,na.rm=TRUE),Salinity.Min=mean(Salinity.Min,na.rm=TRUE),Chlorophyll.Mean=mean(Chlorophyll.Mean,na.rm=TRUE),Nitrate.Mean=mean(Nitrate.Mean,na.rm=TRUE),Phosphate.Mean=mean(Phosphate.Mean,na.rm=TRUE),Light.bottom.Min=mean(Light.bottom.Min,na.rm=TRUE),Par.Mean=mean(Par.Mean,na.rm=TRUE),Dist_To_River=mean(Dist_To_River,na.rm=TRUE),Dist_To_Shore=mean(Dist_To_Shore,na.rm=TRUE))%>%
  ungroup()


seagrass_survey_AND_Clippings_By_Quadrat=join(seagrass_survey_AND_Clippings_By_Quadrat,Environmental_Factors_Sites,by="Site",type="left")



Seagrass_Data_Quadrat_Level=seagrass_survey_AND_Clippings_By_Quadrat%>%
  mutate(Seagrass_Biomass_g_per_sqm=Seagrass_Biomass_gDW/0.0625,
         Macro_Algae_Biomass_g_per_sqm=Macro_Algae_Biomass_gDW/0.0625,
         Thalassia_testudinum_g_per_sqm=Thalassia_testudinum_gDW/0.0625,
         Syringodium_filiforme_g_per_sqm=Syringodium_filiforme_gDW/0.0625,
         Halodule_wrightii_g_per_sqm=Halodule_wrightii_gDW/0.0625)%>%
  dplyr::select(1:3,7:26,44:48,32:43)

write.csv(Seagrass_Data_Quadrat_Level,"data_output/Seagrass_Clippings_QAQC_Quadrat_03_31_2021.csv")


Grainsize_QAQC_Quadrat_Level_By_DepthBin=Grainsize_QAQC%>%
  mutate(Sediment_Depth_Factor=ifelse(Slice_Number==4,"shallow","deep"))%>%
  mutate(Sediment_Depth_Factor=factor(Sediment_Depth_Factor,levels=c("shallow","deep")))%>%
  group_by(Site,Quadrat,Sediment_Depth_Factor)%>%
  dplyr::summarize(Percent_Shell=mean(Percent_Shell,na.rm=TRUE),Percent_Gravel=mean(Percent_Gravel,na.rm=TRUE),Percent_Coarse=mean(Percent_Coarse,na.rm=TRUE),Percent_Medium=mean(Percent_Medium,na.rm=TRUE),Percent_Fine=mean(Percent_Fine,na.rm=TRUE),Percent_Silt=mean(Percent_Silt,na.rm=TRUE))%>%
  ungroup()

Grainsize_QAQC_Quadrat_Level_By_DepthBin[is.na(Grainsize_QAQC_Quadrat_Level_By_DepthBin)] <- NA


```

#Getting Site Level Data 
```{r}
#GOING TO SITE LEVEL BY DEPTH BIN
LOI_QAQC_Site_Level_By_DepthBin=LOI_QAQC_Quadrat_Level_By_DepthBin%>%
  dplyr::group_by(Site,Factor,Sediment_Depth_Factor)%>%
  dplyr::summarize(OLOI=mean(OLOI,na.rm=TRUE),
                   ILOI=mean(ILOI,na.rm=TRUE),
                   Carbon=mean(Carbon,na.rm=TRUE),
                   Rhizome_Stock_g_per_sqm=mean(Rhizome_g_per_sqm,na.rm=TRUE),
                   Shell_Stock_g_per_sqm=mean(Shell_g_per_sqm,na.rm=TRUE),
                   Organic_Carbon_Stock_g_per_sqm=mean(OC_Stock_g_per_sqm,na.rm=TRUE),
                   Inorganic_Carbon_Stock_g_per_sqm=mean(IOC_Stock_g_per_sqm,na.rm=TRUE),
                   Total_Carbon_Stock_g_per_sqm=mean(Total_C_Stock_g_per_sqm,na.rm=TRUE))%>%
      ungroup()



Seagrass_Data_Site_Level=Seagrass_Data_Quadrat_Level%>%
  group_by(Region,Site,Factor,Seagrass_Landscape)%>%
  summarize_at(vars(month:Dist_To_Shore),mean,na.rm=TRUE)


ggplot(Seagrass_Data_Site_Level,aes(x=Epiphite_Blade_Load,fill=Region))+geom_boxplot()+xlab("Epiphtye Blade Load (% of Blades)") +ylab("Regions")+coord_flip()+ggtitle("A")

ggplot(Seagrass_Data_Site_Level,aes(x=Epiphite_Shoot_Load,fill=Region))+geom_boxplot()+xlab("Epiphtye Shoot Load (% of Shoots)") +ylab("Regions")+coord_flip()+ggtitle("B")


Grainsize_QAQC_Site_Level_By_DepthBin=Grainsize_QAQC%>%
    mutate(Sediment_Depth_Factor=ifelse(Slice_Number==4,"shallow","deep"))%>%
  mutate(Sediment_Depth_Factor=factor(Sediment_Depth_Factor,levels=c("shallow","deep")))%>%
  group_by(Site,Sediment_Depth_Factor)%>%
  dplyr::summarize(Percent_Shell=mean(Percent_Shell,na.rm=TRUE),Percent_Gravel=mean(Percent_Gravel,na.rm=TRUE),Percent_Coarse=mean(Percent_Coarse,na.rm=TRUE),Percent_Medium=mean(Percent_Medium,na.rm=TRUE),Percent_Fine=mean(Percent_Fine,na.rm=TRUE),Percent_Silt=mean(Percent_Silt,na.rm=TRUE))%>%
  ungroup()
names(Grainsize_QAQC_Site_Level_By_DepthBin)

Grainsize_QAQC_Site_Level_By_DepthBin[is.na(Grainsize_QAQC_Site_Level_By_DepthBin)] <- NA


```


#MAKING THE BLUE CARBON DATASETS
```{r}

#Quadrat Level
BlueCarbon_QAQC_Quadrat_Level_By_DepthBin=plyr::join(LOI_QAQC_Quadrat_Level_By_DepthBin,Seagrass_Data_Quadrat_Level,by=c("Site","Quadrat","Factor"),match="all",type="left")


BlueCarbon_QAQC_Quadrat_Level_By_DepthBin=plyr::join(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin,Grainsize_QAQC_Quadrat_Level_By_DepthBin,by=c("Site","Quadrat","Sediment_Depth_Factor"),match="all",type="left")


test=BlueCarbon_QAQC_Quadrat_Level_By_DepthBin[c(1:4,59:64)]

New_Dist_To_River<-read.csv("arc_output/New_Dist_To_River_Calculation.csv")
Meadow_Structure<-read.csv("data/Carbon/Seagrass_Meadow_Type_Data_QAQC_2019.csv")

BlueCarbon_QAQC_Quadrat_Level_By_DepthBin=join(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin,Meadow_Structure[c(4:5)],by=c("Site"),match="all",type="inner")

BlueCarbon_QAQC_Quadrat_Level_By_DepthBin=join(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin,New_Dist_To_River[c(2,5)],by=c("Site"),match="all",type="inner")

BlueCarbon_QAQC_Quadrat_Level_By_DepthBin$Dist_To_River<-BlueCarbon_QAQC_Quadrat_Level_By_DepthBin$Dist_To_River_km


names(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin)

BlueCarbon_QAQC_Quadrat_Level_By_DepthBin=BlueCarbon_QAQC_Quadrat_Level_By_DepthBin[c(1:65)]%>%
  mutate(Cover_Level=ifelse(Total_Seagrass_Cover>=50,"high",ifelse(Total_Seagrass_Cover<50 & Total_Seagrass_Cover>5,"low",ifelse(Total_Seagrass_Cover<5,"none", Total_Seagrass_Cover))))%>%
  mutate(TH_PA=ifelse(Thalassia.testudinum>0,1,0),SY_PA=ifelse(Syringodium.filiforme>0,1,0),HA_PA=ifelse(Halodule.wrightii>0,1,0),TH_PA=as.factor(TH_PA),SY_PA=as.factor(SY_PA),HA_PA=as.factor(HA_PA))
# %>%
  # mutate(Factor=ifelse(Cover_Level=="none","Control","Seagrass"))


# test=BlueCarbon_QAQC_Quadrat_Level_By_DepthBin%>%
#     dplyr::group_by(Site,Quadrat)%>%
#     dplyr::summarize(n=n())

summary(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin)

  
write.csv(BlueCarbon_QAQC_Quadrat_Level_By_DepthBin,file="data_output/BlueCarbon_QAQC_Quadrat_Level_By_DepthBin.csv")



#Site Level
BlueCarbon_QAQC_Site_Level_By_DepthBin=plyr::join(LOI_QAQC_Site_Level_By_DepthBin,Seagrass_Data_Site_Level,by=c("Site","Factor"),match="all",type="left")


BlueCarbon_QAQC_Site_Level_By_DepthBin=plyr::join(BlueCarbon_QAQC_Site_Level_By_DepthBin,Grainsize_QAQC_Site_Level_By_DepthBin,by=c("Site","Sediment_Depth_Factor"),match="all",type="left")


BlueCarbon_QAQC_Site_Level_By_DepthBin=join(BlueCarbon_QAQC_Site_Level_By_DepthBin,Meadow_Structure[c(4:5)],by=c("Site"),match="all",type="inner")

BlueCarbon_QAQC_Site_Level_By_DepthBin=join(BlueCarbon_QAQC_Site_Level_By_DepthBin,New_Dist_To_River[c(2,5)],by=c("Site"),match="all",type="inner")

BlueCarbon_QAQC_Site_Level_By_DepthBin$Dist_To_River<-BlueCarbon_QAQC_Site_Level_By_DepthBin$Dist_To_River_km


names(BlueCarbon_QAQC_Site_Level_By_DepthBin)

BlueCarbon_QAQC_Site_Level_By_DepthBin=BlueCarbon_QAQC_Site_Level_By_DepthBin[c(1:54)]%>%
  mutate(Cover_Level=ifelse(Total_Seagrass_Cover>=50,"high",ifelse(Total_Seagrass_Cover<50 & Total_Seagrass_Cover>5,"low",ifelse(Total_Seagrass_Cover<5,"none", Total_Seagrass_Cover))))%>%
  mutate(TH_PA=ifelse(Thalassia.testudinum>0,1,0),SY_PA=ifelse(Syringodium.filiforme>0,1,0),HA_PA=ifelse(Halodule.wrightii>0,1,0),TH_PA=as.factor(TH_PA),SY_PA=as.factor(SY_PA),HA_PA=as.factor(HA_PA))
# %>%
  # mutate(Factor=ifelse(Cover_Level=="none","Control","Seagrass"))


# test=BlueCarbon_QAQC_Quadrat_Level_By_DepthBin%>%
#     dplyr::group_by(Site,Quadrat)%>%
#     dplyr::summarize(n=n())

summary(BlueCarbon_QAQC_Site_Level_By_DepthBin)

  
write.csv(BlueCarbon_QAQC_Site_Level_By_DepthBin,file="data_output/BlueCarbon_QAQC_Site_Level_By_DepthBin.csv")

save.image(file="C:/Users/jennm/Dropbox/GITHUB/Disseratation/Saved_RData/Blue_Carbon_Datasets.RData")

```


